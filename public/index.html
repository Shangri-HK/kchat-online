<!DOCTYPE html>
<html>
<head>
	<title>K'chat</title>
	<link rel="icon" type="image/png" href="icon.png" />
	<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
	<script src="https://code.jquery.com/jquery-latest.min.js"> </script>
	<script src="/socket.io/socket.io.js"></script>
	<link rel="stylesheet" type="text/css" href="style.css">
</head>
<body id="body">


	<!-- LOGO HEADER -->
	<div id="header">
		<a href="kchat-online.herokuapp.com"><img src="logo.png" id="logo"/></a>
	</div>
	<div class="container" id="container">



		<!-- MODE CINEMA -->
		<input type="submit" id="cinemaOn" class="btn btn-primary" value="Show cinema mode"  style="display: none;" onclick="cinemaOn()" /><br />
		<div id="cinema" style="display:none;"/>
			<iframe  id="youtubeWindow" width="1000" height="500" src="https://www.youtube.com/embed/" style="margin-top: 5px; margin-left: 102px;"></iframe><br />
			<div id="youtubeForm">
				<input class="form-control" id="youtubeLink" style="width:800px; float:left; margin-left: 102px; background-color: grey;"/>
				<input type="submit" id="youtubeSubmit" class="btn btn-primary" value="OK"  onclick="launchVideo()" />
			</div>
			<input type="submit" id="cinemaOut" class="btn btn-primary" value="Hide cinema mode"  onclick="cinemaOut()" />
		</div>



		<!-- LOGIN -->
		<div id="userFormArea" class="row">
			<div class="col-md-12">
				<form id="userForm">
					<div class="form-group">
						<label style="color: white">Enter Username</label>
						<input class="form-control" id="username" />
						<br />
						<label style="color: white">Avatar Link</label>
						<input class="form-control" id="avatarLink" /><br />
						<input type="submit" id="login" class="btn btn-primary" value="Login" /><br />
					</div>
				</form>
			</div>
		</div>



		<!-- MAIN WINDOW -->
		<div id="messageArea" class="row">



			<!-- LEFT COLUMN -->
			<div class="col-md-4" id="userList" style="overflow: auto;">



				<!-- SETTINGS -->
				<form class="col-md-12" id="config" style="display: none;">
					<label style="color: white; margin-top: 20px;">Username</label>
					<textarea class="form-control" id="pseudo"></textarea>
					<label style="color: white">Avatar</label>
					<textarea class="form-control" id="image"></textarea>
					<label style="color: white">Username color</label>
					<textarea class="form-control" id="usernameColor" placeholder="ex: #FA4D4D"></textarea>
					<label style="color: white">Username Glow</label>
					<textarea class="form-control" id="usernameGlow" placeholder="ex: #FA4D4D"></textarea>
					<label style="color: white">Background</label>
					<textarea class="form-control" id="background"></textarea>
					<label style="color: white">Color Theme</label>
					<textarea class="form-control" id="colorTheme" placeholder="ex: #FA4D4D"></textarea>
					<div style="display: flex; flex-wrap: nowrap;">
						<input type="button" id="defaultColor" style="background-color: #FA4D4D" onclick="changeColor('#FA4D4D')"/>
						<input type="button" id="blue" style="background-color: #4F94FA" onclick="changeColor('#4F94FA')"/>
						<input type="button" id="black" style="background-color: #191919" onclick="changeColor('#191919')"/>
						<input type="button" id="grey" style="background-color: #9F9F9F" onclick="changeColor('#9F9F9F')"/>
						<input type="button" id="green" style="background-color: #94FA50" onclick="changeColor('#94FA50')"/>
						<input type="button" id="orange" style="background-color: #FAB04E" onclick="changeColor('#FAB04E')"/>
					</div>
				</form>
				<input type="button" id="ok" class="btn btn-primary" value="OK" style="display: none;" onclick="changeInfo()" />



				<!-- ONLINE USERS -->
				<div class="well" id="usersCol">
					<h4>Online Users</h4>
					<ul class="list-group" id="users"></ul>
				</div>
				
			</div>



			<!-- CHAT -->
			<div class="col-md-8" id="chatWindow">

				<ul class="list-group" id="chat"></ul>
				<input type="button" id="settings" class="btn btn-primary" value="Settings"  onclick="showConfig()" />
				<form id="messageForm">
					<div class="form-group">
						<textarea class="form-control" id="message"></textarea>
						<br />
					</div>
				</form>
			</div>
		</div>
	</div>

	<script>
		var socket = io.connect();
		var audio = new Audio('notif.mp3');
		var $messageForm = $('#messageForm');
		var $message = $('#message');
		var $chat = $('#chat');
		var $userForm = $('#userForm');
		var $messageArea = $('#messageArea');
		var $userFormArea = $('#userFormArea');
		var $users = $('#users');
		var $username = $('#username');
		var $settings = $('#settings');
		var $config = $('#config');
		var $avatarLink = $('#avatarLink');
		var $image = $('#image');
		var $pseudo = $('#pseudo');;
		var $prevImage;
		var $prevPseudo = '';
		var $cinema = $('#cinema');
		var $youtubeLink = $('#youtubeLink');
		var $background = $('#background');
		var $colorTheme = $('#colorTheme');
		var $usernameColor = $('#usernameColor');
		var $usernameGlow = $('#usernameGlow');

		//Setting inputs from cookies
		$username.val(readCookie("username"));
		$avatarLink.val(readCookie("avatar"));
		$pseudo.val(readCookie("username"));
		$image.val(readCookie("avatar"));
		$usernameColor.val(readCookie("usernameColor"));
   		$usernameGlow.val(readCookie("usernameGlow"));
   		$background.val(readCookie("background"));
		document.getElementById('body').style.backgroundImage = "url(background.png)";


		//Change the theme
		function changeColor(data)
		{
			document.getElementById('header').style.backgroundColor = data;
			document.getElementById('settings').style.backgroundColor = data;
			document.getElementById('ok').style.backgroundColor = data;
			document.getElementById('ok').style.border = "1px solid " + data;
			document.getElementById('settings').style.border = "1px solid " + data;
			document.getElementById('cinemaOn').style.border = "1px solid " + data;
			document.getElementById('cinemaOn').style.backgroundColor = data;
			createCookie("colorTheme", data);
		}


		//Enable the cinema mode
		function cinemaOn()
		{
			$('#cinema').fadeIn();
			document.getElementById('chat').style.height = "320px";
			document.getElementById('message').style.height = "30px";
			document.getElementById('container').style.marginTop = "0px";
			document.getElementById('chat').style.marginBottom = "0px";
			document.getElementById('userList').style.height = "320px";
			document.getElementById('settings').style.height = "20px";
			if (readCookie("background" != ""))
				$('#body').css({'background': 'linear-gradient( rgba(0, 0, 0, 0.7), rgba(0, 0, 0, 0.7) ), url(' + readCookie("background") + ')'});
			else
				$('#body').css({'background': 'linear-gradient( rgba(0, 0, 0, 0.7), rgba(0, 0, 0, 0.7) ), url(background.png)'});
			$('#cinemaOn').fadeOut();
			//$('html, body').css({'height': '100%'};
		}


		//Disable cinema mode
		function cinemaOut()
		{
			document.getElementById('container').style.marginTop = "20px";
			$('#cinema').fadeOut();
			$('#cinemaOn').fadeIn();
			if (readCookie("background" != ""))
				$('#body').css({'background': 'linear-gradient( rgba(0, 0, 0, 0), rgba(0, 0, 0, 0) ), url(' + readCookie("background") + ')'});
			else
				$('#body').css({'background': 'linear-gradient( rgba(0, 0, 0, 0), rgba(0, 0, 0, 0) ), url(background.png)'});
		}


		//Enable the settings window
		function showConfig()
		{
   			document.getElementById('config').style.display = "block";
   			document.getElementById('ok').style.display = "block";
   			document.getElementById('usersCol').style.display = "none";
   			document.getElementById('settings').style.display = "none";
   			document.getElementById('image').value = escapeHtml($image);
   			document.getElementById('pseudo').value = escapeHtml($pseudo);
   			$pseudo.val(readCookie("username"));
   			$image.val(readCookie("avatar"));
   			//$usernameColor.val(readCookie("usernameColor"));
   			$usernameGlow.val(readCookie("usernameGlow"));
   			$background.val(readCookie("background"));

		}

		function autoLaunch(data)
		{
			alert(data);
		}

		function isYoutube(data)
		{
			return (data);
			var href = data.split('"')[1];
			var embed = href.split('/');
			if (embed != null)
			{
				for (var i = 0; i < embed.length; i++)
				{
					if (embed[i] == "www.youtube.com" || embed[i] == "www.youtube.com&quot")
					{

						return data + '  ' + '<a id="myLink" href="#" onclick="autoLaunch(' +  embed[++i] + ');">' + ' <strong style="color:red;">â–º play on cinema mode.</strong></a>';
						//alert("its youtube");
						cinemaOn();
					}
						//document.getElementById('youtubeWindow').src = "https://www.youtube.com/embed/" + embed[i+1].split('=')[1].split('&')[0];
				}
			}
			return data;
			//<a href="http://www.youtube.com" target="_blank">www.youtube.com</a>
		}


		//Initialize the youtube video link
		function launchVideo()
		{
			var link = $youtubeLink.val();
			var embed = link.split('/');
			for (var i = 0; i < embed.length; i++)
			{
				if (embed[i] == "www.youtube.com")
					document.getElementById('youtubeWindow').src = "https://www.youtube.com/embed/" + embed[i+1].split('=')[1].split('&')[0];
			}
		}


		//Return the text-shadow CSS correctly
		function returnGlow(data)
		{
			if (data != "")
				return "text-shadow: 0px 0px 5px" +  data + ";"
			else
				return "";
		}


		//Set the options selected
		function changeInfo()
		{
			if ($colorTheme.val() != "")
				changeColor(escapeHtml($colorTheme.val()).toString());
			if ($usernameColor.val() != "")
				{
					createCookie("usernameColor", escapeHtml(document.getElementById('usernameColor').value));
				}
			else
				createCookie("usernameColor", "");
			if ($usernameGlow.val() != "")
				{
					createCookie("usernameGlow", escapeHtml(document.getElementById('usernameGlow').value));
				}
			else
				createCookie("usernameGlow", "");
			if (escapeHtml($background.val()) == "")
				document.getElementById('body').style.backgroundImage = "url(background.png)";
			else
				document.getElementById('body').style.backgroundImage = "url(" + escapeHtml($background.val()) + ")";
			createCookie("background", escapeHtml($background.val()));
			socket.emit('send message', document.getElementById('pseudo').value, document.getElementById('image').value, escapeHtml(document.getElementById('usernameColor').value), escapeHtml(document.getElementById('usernameGlow').value), false);
			createCookie("username", document.getElementById('pseudo').value);
			createCookie("avatar", document.getElementById('image').value);
			showOffSettings();
		}


		//Disable the settings sidebar
		function showOffSettings()
		{
			document.getElementById('config').style.display = "none";
   			document.getElementById('ok').style.display = "none";
   			document.getElementById('usersCol').style.display = "block";
   			document.getElementById('settings').style.display = "block";
   			document.getElementById('settings').style.marginTop = "182px";
		}


		//Create the cookie
		function createCookie(name,value) {
			document.cookie = name+"="+escapeHtml(value);
		}


		//Read the cookie
		function readCookie(name) {
			var nameEQ = name + "=";
			var ca = document.cookie.split(';');
			for( var i=0; i < ca.length; i++) {
				var c = ca[i];
				while (c.charAt(0)==' ') c = c.substring(1,c.length);
				if (c.indexOf(nameEQ) == 0) return c.substring(nameEQ.length,c.length);
			}
			return null;
		}


		//Protect from html injection
		function escapeHtml(text) {
		  var map = {
		    '&': '&amp;',
		    '<': '&lt;',
		    '>': '&gt;',
		    '"': '&quot;',
		    "'": '&#039;'
		  };
		  return text.replace(/[&<>"']/g, function(m) { return map[m]; });
		}


		//Make a html link
		function linkify(inputText) {
		    var replacedText, replacePattern1, replacePattern2, replacePattern3;

		    //URLs starting with http://, https://, or ftp://
		    replacePattern1 = /(\b(https?|ftp):\/\/[-A-Z0-9+&@#\/%?=~_|!:,.;]*[-A-Z0-9+&@#\/%=~_|])/gim;
		    replacedText = inputText.replace(replacePattern1, '<a href="$1" target="_blank">$1</a>');

		    //URLs starting with "www." (without // before it, or it'd re-link the ones done above).
		    replacePattern2 = /(^|[^\/])(www\.[\S]+(\b|$))/gim;
		    replacedText = replacedText.replace(replacePattern2, '$1<a href="http://$2" target="_blank">$2</a>');

		    //Change email addresses to mailto:: links.
		    replacePattern3 = /(([a-zA-Z0-9\-\_\.])+@[a-zA-Z\_]+?(\.[a-zA-Z]{2,6})+)/gim;
		    replacedText = replacedText.replace(replacePattern3, '<a href="mailto:$1">$1</a>');

		    return replacedText;
		}


		//Client
		$(function(){

			$messageForm.submit(function(e){
				e.preventDefault();
				socket.emit('send message', $message.val(), null, null, null, true);
				$message.val('');
			});


			//Message emit on chat or on user's connection/deconnection
			socket.on('new message', function(data){
				if (data.alert == 0){
				$chat.append('<li class="list-group-item" id="affichage"><img src="' + escapeHtml(data.avatar) + '" id="avatar"/><strong style="color:' + data.color + ';' + returnGlow(data.glow) + '">' + escapeHtml(data.user) + '</strong><br />' + isYoutube(linkify(escapeHtml(data.msg))) +'</li>')}
				else if (data.alert == 1)
					$chat.append('<li class="list-group-item" id="affichage" style="background-color: grey; height: 20px;font-size: 10px; overflow:hidden; padding-top: 2px;"><strong>' + data.user + ' is connected.<strong/>')
				else
					$chat.append('<li class="list-group-item" id="affichage" style="background-color: grey; height: 20px;font-size: 10px; overflow:hidden; padding-top: 2px;"><strong>' + data.user + ' has disconnected.<strong/>')
				var x = document.getElementById('chat'); 
				x.scrollTop = x.scrollHeight;
				audio.volume = 0.2;
				audio.play();
			});


			//Add the user's informations at login 
			$("#login").click(function(e){
				e.preventDefault();
				socket.emit('new user', $username.val(), $avatarLink.val(), readCookie("usernameColor"), readCookie("usernameGlow"), true, function(data){
					if(data)
					{
						$userFormArea.hide();
						$messageArea.fadeIn();
						$('#cinemaOn').fadeIn();
						changeColor(readCookie("colorTheme"));
						if (readCookie("background") == "")
							document.getElementById('body').style.backgroundImage = "url(background.png)";
						else
							document.getElementById('body').style.backgroundImage = "url(" + readCookie("background") + ")";
					}
				});
				createCookie("username", $pseudo);
				createCookie("avatar", $image);
				document.getElementById('pseudo').value = $username.val();
				$username.val('');
			});


			//Show the users online on the sidebar
			socket.on('get users', function(data){
				var html = '';
				for(i = 0; i < data.length; i++)
				{
					html += '<li class="list-group-item">' + escapeHtml(data[i]) + '</li>';
				}
				$users.html(html);
			});
		});


		//Make the enter button send message
		$("#message").keypress(function (e) {
    		if(e.which == 13 && !e.shiftKey) 
    		{        
        		$(this).closest("form").submit();
        		e.preventDefault();
        		return false;
   			}
		});

		//Enable the line break
		$("#image").keypress(function (e) {
    		if(e.which == 13 && !e.shiftKey) 
    		{        
        		return false;
   			}
		});


		//Enable the line break
		$("#pseudo").keypress(function (e) {
    		if(e.which == 13 && !e.shiftKey) 
    		{        
        		return false;
   			}
		});


		//Enable the line break
		$("#colorTheme").keypress(function (e) {
    		if(e.which == 13 && !e.shiftKey) 
    		{        
        		return false;
   			}
		});


		//Enable the line break
		$("#usernameColor").keypress(function (e) {
    		if(e.which == 13 && !e.shiftKey) 
    		{        
        		return false;
   			}
		});


		//Enable the line break
		$("#usernameGlow").keypress(function (e) {
    		if(e.which == 13 && !e.shiftKey) 
    		{        
        		return false;
   			}
		});
	</script>
</body>
</html>